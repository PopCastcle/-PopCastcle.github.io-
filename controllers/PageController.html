<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>castcle-api documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css" media="(prefers-color-scheme: dark)">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">castcle-api documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content controller">
                   <div class="content-data">





<ol class="breadcrumb">
  <li>Controllers</li>
  <li >PageController</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>apps/bases/src/app/controllers/pages/pages.controller.ts</code>
        </p>







            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#createPage" >createPage</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#deletePage" >deletePage</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getAllPages" >getAllPages</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getPageContents" >getPageContents</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#getPageFromId" >getPageFromId</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#updatePage" >updatePage</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createPage"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>createPage</b></span>
                        <a href="#createPage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>createPage(req: <a href="../interfaces/CredentialRequest.html" target="_self">CredentialRequest</a>, body: <a href="../classes/PageDto.html" target="_self">PageDto</a>)</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@ApiBearerAuth()<br />@ApiBody({type: PageResponse})<br />@ApiResponse({status: 201, type: PageDto})<br />@UseInterceptors(CredentialInterceptor)<br />@Post(&#x27;pages&#x27;)<br /></code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="146"
                            class="link-to-prism">apps/bases/src/app/controllers/pages/pages.controller.ts:146</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>req</td>
                                    <td>
                                                <code><a href="../interfaces/CredentialRequest.html" target="_self" >CredentialRequest</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>body</td>
                                    <td>
                                                <code><a href="../classes/PageDto.html" target="_self" >PageDto</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deletePage"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>deletePage</b></span>
                        <a href="#deletePage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>deletePage(req: <a href="../interfaces/CredentialRequest.html" target="_self">CredentialRequest</a>, id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@ApiBearerAuth()<br />@ApiResponse({status: 204})<br />@HttpCode(204)<br />@Delete(&#x27;pages/:id&#x27;)<br /></code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="256"
                            class="link-to-prism">apps/bases/src/app/controllers/pages/pages.controller.ts:256</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>req</td>
                                    <td>
                                                <code><a href="../interfaces/CredentialRequest.html" target="_self" >CredentialRequest</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getAllPages"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getAllPages</b></span>
                        <a href="#getAllPages"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getAllPages(sortByOption: literal type, pageOption: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, limitOption: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>)</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@ApiBearerAuth()<br />@ApiOkResponse({type: PagesResponse})<br />@UseInterceptors(PageInterceptor)<br />@Get(&#x27;pages&#x27;)<br /></code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="228"
                            class="link-to-prism">apps/bases/src/app/controllers/pages/pages.controller.ts:228</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Default value</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>sortByOption</td>
                                    <td>
                                            <code>literal type</code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>DEFAULT_CONTENT_QUERY_OPTIONS.sortBy</code>
                                    </td>

                                </tr>
                                <tr>
                                    <td>pageOption</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>DEFAULT_CONTENT_QUERY_OPTIONS.page</code>
                                    </td>

                                </tr>
                                <tr>
                                    <td>limitOption</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>DEFAULT_CONTENT_QUERY_OPTIONS.limit</code>
                                    </td>

                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>        <code><a href="../classes/PagesResponse.html" target="_self" >Promise&lt;PagesResponse&gt;</a></code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getPageContents"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getPageContents</b></span>
                        <a href="#getPageContents"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getPageContents(id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, req: <a href="../interfaces/CredentialRequest.html" target="_self">CredentialRequest</a>, sortByOption: literal type, pageOption: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, limitOption: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank">number</a>, contentTypeOption: <a href="../classes/Content.html" target="_self">ContentType</a>)</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@ApiBearerAuth()<br />@ApiOkResponse({type: ContentResponse})<br />@UseInterceptors(ContentsInterceptor)<br />@ApiQuery({name: &#x27;sortBy&#x27;, enum: SortByEnum, required: false})<br />@ApiQuery({name: &#x27;page&#x27;, type: Number, required: false})<br />@ApiQuery({name: &#x27;limit&#x27;, type: Number, required: false})<br />@ApiQuery({name: &#x27;type&#x27;, enum: ContentType, required: false})<br />@Get(&#x27;pages/:id/contents&#x27;)<br /></code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="300"
                            class="link-to-prism">apps/bases/src/app/controllers/pages/pages.controller.ts:300</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Default value</td>
                                    <td>Description</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                    </td>

                                    <td>
                                    </td>
                                </tr>
                                <tr>
                                    <td>req</td>
                                    <td>
                                                <code><a href="../interfaces/CredentialRequest.html" target="_self" >CredentialRequest</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                    </td>

                                    <td>
                                        <p>that contain current user credential</p>

                                    </td>
                                </tr>
                                <tr>
                                    <td>sortByOption</td>
                                    <td>
                                            <code>literal type</code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>DEFAULT_CONTENT_QUERY_OPTIONS.sortBy</code>
                                    </td>

                                    <td>
                                    </td>
                                </tr>
                                <tr>
                                    <td>pageOption</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>DEFAULT_CONTENT_QUERY_OPTIONS.page</code>
                                    </td>

                                    <td>
                                    </td>
                                </tr>
                                <tr>
                                    <td>limitOption</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>DEFAULT_CONTENT_QUERY_OPTIONS.limit</code>
                                    </td>

                                    <td>
                                    </td>
                                </tr>
                                <tr>
                                    <td>contentTypeOption</td>
                                    <td>
                                                <code><a href="../classes/Content.html" target="_self" >ContentType</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>DEFAULT_CONTENT_QUERY_OPTIONS.type</code>
                                    </td>

                                    <td>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;ContentsResponse&gt;</code>

                    </div>
                    <div class="io-description">
                        <p>all contents that has been map with contentService.getContentsFromUser()</p>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getPageFromId"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>getPageFromId</b></span>
                        <a href="#getPageFromId"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getPageFromId(req: <a href="../interfaces/CredentialRequest.html" target="_self">CredentialRequest</a>, id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@ApiBearerAuth()<br />@ApiOkResponse({type: PageResponseDto})<br />@UseInterceptors(PageInterceptor)<br />@Get(&#x27;pages/:id&#x27;)<br /></code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="213"
                            class="link-to-prism">apps/bases/src/app/controllers/pages/pages.controller.ts:213</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>req</td>
                                    <td>
                                                <code><a href="../interfaces/CredentialRequest.html" target="_self" >CredentialRequest</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;PageResponseDto&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updatePage"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>updatePage</b></span>
                        <a href="#updatePage"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>updatePage(req: <a href="../interfaces/CredentialRequest.html" target="_self">CredentialRequest</a>, id: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, body: <a href="../classes/UpdatePageDto.html" target="_self">UpdatePageDto</a>)</code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <b>Decorators : </b>
                    <br />
                    <code>@ApiBearerAuth()<br />@ApiBody({type: UpdatePageDto})<br />@ApiResponse({status: 201, type: PageDto})<br />@HttpCode(201)<br />@UseInterceptors(PageInterceptor)<br />@Put(&#x27;pages/:id&#x27;)<br /></code>
                </td>
            </tr>

            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="182"
                            class="link-to-prism">apps/bases/src/app/controllers/pages/pages.controller.ts:182</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>req</td>
                                    <td>
                                                <code><a href="../interfaces/CredentialRequest.html" target="_self" >CredentialRequest</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>id</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                                <tr>
                                    <td>body</td>
                                    <td>
                                                <code><a href="../classes/UpdatePageDto.html" target="_self" >UpdatePageDto</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>unknown</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">/*
 * Copyright (c) 2021, Castcle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 3 only, as
 * published by the Free Software Foundation.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 * version 3 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 3 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Castcle, 22 Phet Kasem 47/2 Alley, Bang Khae, Bangkok,
 * Thailand 10160, or visit www.castcle.com if you need additional information
 * or have any questions.
 */

import {
  Body,
  Controller,
  Delete,
  Get,
  HttpCode,
  Param,
  Post,
  Put,
  Req,
  UseInterceptors
} from &#x27;@nestjs/common&#x27;;
import { AppService } from &#x27;../../app.service&#x27;;
import {
  AuthenticationService,
  UserService,
  ContentService
} from &#x27;@castcle-api/database&#x27;;
import { CastLogger, CastLoggerOptions } from &#x27;@castcle-api/logger&#x27;;
import {
  ContentResponse,
  ContentsResponse,
  ContentType,
  DEFAULT_CONTENT_QUERY_OPTIONS,
  PageDto,
  PagesResponse,
  UpdatePageDto,
  PageResponse,
  PageResponseDto
} from &#x27;@castcle-api/database/dtos&#x27;;
import {
  CredentialInterceptor,
  CredentialRequest,
  ContentsInterceptor
} from &#x27;@castcle-api/utils/interceptors&#x27;;
import {
  SortByPipe,
  PagePipe,
  LimitPipe,
  SortByEnum,
  ContentTypePipe
} from &#x27;@castcle-api/utils/pipes&#x27;;
import { CastcleException, CastcleStatus } from &#x27;@castcle-api/utils/exception&#x27;;
import { Image, UploadOptions } from &#x27;@castcle-api/utils/aws&#x27;;
import {
  ApiBearerAuth,
  ApiBody,
  ApiHeader,
  ApiOkResponse,
  ApiQuery,
  ApiResponse
} from &#x27;@nestjs/swagger&#x27;;
import { UserDocument, UserType } from &#x27;@castcle-api/database/schemas&#x27;;
import { PageInterceptor } from &#x27;../../interceptors/page.interceptor&#x27;;
import { Query } from &#x27;@nestjs/common&#x27;;
import { Configs } from &#x27;@castcle-api/environments&#x27;;

@ApiHeader({
  name: Configs.RequiredHeaders.AcceptLanguague.name,
  description: Configs.RequiredHeaders.AcceptLanguague.description,
  example: Configs.RequiredHeaders.AcceptLanguague.example,
  required: true
})
@ApiHeader({
  name: Configs.RequiredHeaders.AcceptVersion.name,
  description: Configs.RequiredHeaders.AcceptVersion.description,
  example: Configs.RequiredHeaders.AcceptVersion.example,
  required: true
})
@Controller({
  version: &#x27;1.0&#x27;
})
@Controller()
export class PageController {
  constructor(
    private readonly appService: AppService,
    private authService: AuthenticationService,
    private userService: UserService,
    private contentService: ContentService
  ) {}
  private readonly logger &#x3D; new CastLogger(
    PageController.name,
    CastLoggerOptions
  );

  _uploadImage &#x3D; (base64: string, options?: UploadOptions) &#x3D;&gt;
    Image.upload(base64, options);

  /**
   *
   * @param {string} idOrCastCleId
   * @param {CredentialRequest} req
   * @returns {UserDocument} User schema that got from userService.getUserFromId() or authService.getUserFromCastcleId()
   */
  _getPageByIdOrCastcleId &#x3D; async (
    idOrCastCleId: string,
    req: CredentialRequest
  ) &#x3D;&gt; {
    const idResult &#x3D; await this.userService.getUserFromId(idOrCastCleId);
    if (idResult &amp;&amp; idResult.type &#x3D;&#x3D;&#x3D; UserType.Page) return idResult;
    const castcleIdResult &#x3D; await this.authService.getUserFromCastcleId(
      idOrCastCleId
    );
    if (castcleIdResult &amp;&amp; castcleIdResult.type &#x3D;&#x3D;&#x3D; UserType.Page)
      return castcleIdResult;
    else
      throw new CastcleException(
        CastcleStatus.REQUEST_URL_NOT_FOUND,
        req.$language
      );
  };

  @ApiBearerAuth()
  @ApiBody({
    type: PageResponse
  })
  @ApiResponse({
    status: 201,
    type: PageDto
  })
  @UseInterceptors(CredentialInterceptor)
  @Post(&#x27;pages&#x27;)
  async createPage(@Req() req: CredentialRequest, @Body() body: PageDto) {
    //check if page name exist
    const namingResult &#x3D; await this.authService.getUserFromCastcleId(
      body.castcleId
    );
    if (namingResult)
      throw new CastcleException(CastcleStatus.PAGE_IS_EXIST, req.$language);
    //TODO !!! performance issue
    body.avatar &#x3D; (
      await this._uploadImage(body.avatar, {
        filename: &#x60;page-avatar-${body.castcleId}&#x60;
      })
    ).uri;
    body.cover &#x3D; (
      await this._uploadImage(body.cover, {
        filename: &#x60;page-cover-${body.castcleId}&#x60;
      })
    ).uri;
    const page &#x3D; await this.userService.createPageFromCredential(
      req.$credential,
      body
    );
    return page.toPageResponse();
  }

  @ApiBearerAuth()
  @ApiBody({
    type: UpdatePageDto
  })
  @ApiResponse({
    status: 201,
    type: PageDto
  })
  @HttpCode(201)
  @UseInterceptors(PageInterceptor)
  @Put(&#x27;pages/:id&#x27;)
  async updatePage(
    @Req() req: CredentialRequest,
    @Param(&#x27;id&#x27;) id: string,
    @Body() body: UpdatePageDto
  ) {
    //check if page name exist
    const page &#x3D; await this._getPageByIdOrCastcleId(id, req);
    //TODO !!! performance issue
    if (body.avatar)
      page.profile.images.avatar &#x3D; (
        await this._uploadImage(body.avatar, {
          filename: &#x60;page-avatar-${id}&#x60;
        })
      ).uri;
    if (body.cover)
      page.profile.images.cover &#x3D; (
        await this._uploadImage(body.cover, {
          filename: &#x60;page-cover-${id}&#x60;
        })
      ).uri;
    if (body.displayName) page.displayName &#x3D; body.displayName;
    const afterPage &#x3D; await page.save();
    return afterPage.toPageResponse();
  }

  @ApiBearerAuth()
  @ApiOkResponse({
    type: PageResponseDto
  })
  @UseInterceptors(PageInterceptor)
  @Get(&#x27;pages/:id&#x27;)
  async getPageFromId(
    @Req() req: CredentialRequest,
    @Param(&#x27;id&#x27;) id: string
  ): Promise&lt;PageResponseDto&gt; {
    //check if page name exist
    const page &#x3D; await this._getPageByIdOrCastcleId(id, req);
    return page.toPageResponse();
  }

  @ApiBearerAuth()
  @ApiOkResponse({
    type: PagesResponse
  })
  @UseInterceptors(PageInterceptor)
  @Get(&#x27;pages&#x27;)
  async getAllPages(
    @Query(&#x27;sortBy&#x27;, SortByPipe)
    sortByOption: {
      field: string;
      type: &#x27;desc&#x27; | &#x27;asc&#x27;;
    } &#x3D; DEFAULT_CONTENT_QUERY_OPTIONS.sortBy,
    @Query(&#x27;page&#x27;, PagePipe)
    pageOption: number &#x3D; DEFAULT_CONTENT_QUERY_OPTIONS.page,
    @Query(&#x27;limit&#x27;, LimitPipe)
    limitOption: number &#x3D; DEFAULT_CONTENT_QUERY_OPTIONS.limit
  ): Promise&lt;PagesResponse&gt; {
    const pages &#x3D; await this.userService.getAllPages({
      page: pageOption,
      sortBy: sortByOption,
      limit: limitOption
    });
    return {
      payload: pages.items.map((p) &#x3D;&gt; p.toPageResponse()),
      pagination: pages.pagination
    };
  }

  @ApiBearerAuth()
  @ApiResponse({
    status: 204
  })
  @HttpCode(204)
  @Delete(&#x27;pages/:id&#x27;)
  async deletePage(@Req() req: CredentialRequest, @Param(&#x27;id&#x27;) id: string) {
    const page &#x3D; await this._getPageByIdOrCastcleId(id, req);
    if (String(page.ownerAccount) &#x3D;&#x3D;&#x3D; String(req.$credential.account._id)) {
      await page.delete();
      return &#x27;&#x27;;
    } else
      throw new CastcleException(
        CastcleStatus.INVALID_ACCESS_TOKEN,
        req.$language
      );
  }

  /**
   *
   * @param {string} idOrCastcleId of page
   * @param {CredentialRequest} req that contain current user credential
   * @returns {Promise&lt;ContentsResponse&gt;} all contents that has been map with contentService.getContentsFromUser()
   */
  @ApiBearerAuth()
  @ApiOkResponse({
    type: ContentResponse
  })
  @UseInterceptors(ContentsInterceptor)
  @ApiQuery({
    name: &#x27;sortBy&#x27;,
    enum: SortByEnum,
    required: false
  })
  @ApiQuery({
    name: &#x27;page&#x27;,
    type: Number,
    required: false
  })
  @ApiQuery({
    name: &#x27;limit&#x27;,
    type: Number,
    required: false
  })
  @ApiQuery({
    name: &#x27;type&#x27;,
    enum: ContentType,
    required: false
  })
  @Get(&#x27;pages/:id/contents&#x27;)
  async getPageContents(
    @Param(&#x27;id&#x27;) id: string,
    @Req() req: CredentialRequest,
    @Query(&#x27;sortBy&#x27;, SortByPipe)
    sortByOption: {
      field: string;
      type: &#x27;desc&#x27; | &#x27;asc&#x27;;
    } &#x3D; DEFAULT_CONTENT_QUERY_OPTIONS.sortBy,
    @Query(&#x27;page&#x27;, PagePipe)
    pageOption: number &#x3D; DEFAULT_CONTENT_QUERY_OPTIONS.page,
    @Query(&#x27;limit&#x27;, LimitPipe)
    limitOption: number &#x3D; DEFAULT_CONTENT_QUERY_OPTIONS.limit,
    @Query(&#x27;type&#x27;, ContentTypePipe)
    contentTypeOption: ContentType &#x3D; DEFAULT_CONTENT_QUERY_OPTIONS.type
  ): Promise&lt;ContentsResponse&gt; {
    const page &#x3D; await this._getPageByIdOrCastcleId(id, req);
    const contents &#x3D; await this.contentService.getContentsFromUser(page, {
      sortBy: sortByOption,
      limit: limitOption,
      page: pageOption,
      type: contentTypeOption
    });
    return {
      payload: contents.items.map((c) &#x3D;&gt; c.toContentPayload()),
      pagination: contents.pagination
    };
  }
}
</code></pre>
    </div>
</div>









                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'controller';
            var COMPODOC_CURRENT_PAGE_URL = 'PageController.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       
       <script type="module" src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
