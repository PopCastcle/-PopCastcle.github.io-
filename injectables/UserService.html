<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>castcle-api documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css" media="(prefers-color-scheme: dark)">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">castcle-api documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">







<ol class="breadcrumb">
  <li>Injectables</li>
  <li >UserService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>libs/database/src/lib/services/user.service.ts</code>
        </p>





            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#_accountModel" >_accountModel</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#_credentialModel" >_credentialModel</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#_relationshipModel" >_relationshipModel</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#_userModel" >_userModel</a>
                            </li>
                            <li>
                                <a href="#createPageFromCredential" >createPageFromCredential</a>
                            </li>
                            <li>
                                <a href="#createPageFromUser" >createPageFromUser</a>
                            </li>
                            <li>
                                <a href="#deactive" >deactive</a>
                            </li>
                            <li>
                                <a href="#deleteUserFromId" >deleteUserFromId</a>
                            </li>
                            <li>
                                <a href="#follow" >follow</a>
                            </li>
                            <li>
                                <a href="#getAllPages" >getAllPages</a>
                            </li>
                            <li>
                                <a href="#getFollower" >getFollower</a>
                            </li>
                            <li>
                                <a href="#getFollowing" >getFollowing</a>
                            </li>
                            <li>
                                <a href="#getUserFromCredential" >getUserFromCredential</a>
                            </li>
                            <li>
                                <a href="#getUserFromId" >getUserFromId</a>
                            </li>
                            <li>
                                <a href="#reactive" >reactive</a>
                            </li>
                            <li>
                                <a href="#unfollow" >unfollow</a>
                            </li>
                            <li>
                                <a href="#updateUser" >updateUser</a>
                            </li>
                        </ul>
                    </td>
                </tr>






        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(_accountModel: <a href="../classes/Account.html" target="_self">Model&lt;AccountDocument&gt;</a>, _credentialModel: <a href="../interfaces/CredentialModel.html" target="_self">CredentialModel</a>, _userModel: <a href="../interfaces/UserModel.html" target="_self">UserModel</a>, _relationshipModel: <a href="../classes/Relationship.html" target="_self">Model&lt;RelationshipDocument&gt;</a>, contentService: <a href="../injectables/ContentService.html" target="_self">ContentService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="48" class="link-to-prism">libs/database/src/lib/services/user.service.ts:48</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>_accountModel</td>
                                                  
                                                        <td>
                                                                        <code><a href="../classes/Account.html" target="_self" >Model&lt;AccountDocument&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>_credentialModel</td>
                                                  
                                                        <td>
                                                                        <code><a href="../interfaces/CredentialModel.html" target="_self" >CredentialModel</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>_userModel</td>
                                                  
                                                        <td>
                                                                        <code><a href="../interfaces/UserModel.html" target="_self" >UserModel</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>_relationshipModel</td>
                                                  
                                                        <td>
                                                                        <code><a href="../classes/Relationship.html" target="_self" >Model&lt;RelationshipDocument&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>contentService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/ContentService.html" target="_self" >ContentService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>


            <section>
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="_accountModel"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>_accountModel</b></span>
                        <a href="#_accountModel"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../classes/Account.html" target="_self" >Model&lt;AccountDocument&gt;</a></code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <b>Decorators : </b>
                        <br />
                        <code>
                            @InjectModel(&#x27;Account&#x27;)<br />
                        </code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="50" class="link-to-prism">libs/database/src/lib/services/user.service.ts:50</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="_credentialModel"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>_credentialModel</b></span>
                        <a href="#_credentialModel"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../interfaces/CredentialModel.html" target="_self" >CredentialModel</a></code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <b>Decorators : </b>
                        <br />
                        <code>
                            @InjectModel(&#x27;Credential&#x27;)<br />
                        </code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="52" class="link-to-prism">libs/database/src/lib/services/user.service.ts:52</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="_relationshipModel"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>_relationshipModel</b></span>
                        <a href="#_relationshipModel"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../classes/Relationship.html" target="_self" >Model&lt;RelationshipDocument&gt;</a></code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <b>Decorators : </b>
                        <br />
                        <code>
                            @InjectModel(&#x27;Relationship&#x27;)<br />
                        </code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="56" class="link-to-prism">libs/database/src/lib/services/user.service.ts:56</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="_userModel"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>_userModel</b></span>
                        <a href="#_userModel"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>        <code><a href="../interfaces/UserModel.html" target="_self" >UserModel</a></code>

                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <b>Decorators : </b>
                        <br />
                        <code>
                            @InjectModel(&#x27;User&#x27;)<br />
                        </code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="54" class="link-to-prism">libs/database/src/lib/services/user.service.ts:54</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createPageFromCredential"></a>
                    <span class="name">
                        <span ><b>createPageFromCredential</b></span>
                        <a href="#createPageFromCredential"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="120" class="link-to-prism">libs/database/src/lib/services/user.service.ts:120</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="createPageFromUser"></a>
                    <span class="name">
                        <span ><b>createPageFromUser</b></span>
                        <a href="#createPageFromUser"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="128" class="link-to-prism">libs/database/src/lib/services/user.service.ts:128</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deactive"></a>
                    <span class="name">
                        <span ><b>deactive</b></span>
                        <a href="#deactive"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="256" class="link-to-prism">libs/database/src/lib/services/user.service.ts:256</a></div>
                        </td>
                    </tr>

            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>TODO !!! need to find a way to put in transaction
Deactivate User account</p>
</div>
                </td>
            </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description">
                                <b>Parameters :</b>
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                            <tr>
                                                    <td>user</td>
                                            </tr>
                                    </tbody>
                                </table>
                        </div>
                    </td>
                </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="deleteUserFromId"></a>
                    <span class="name">
                        <span ><b>deleteUserFromId</b></span>
                        <a href="#deleteUserFromId"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="117" class="link-to-prism">libs/database/src/lib/services/user.service.ts:117</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="follow"></a>
                    <span class="name">
                        <span ><b>follow</b></span>
                        <a href="#follow"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="170" class="link-to-prism">libs/database/src/lib/services/user.service.ts:170</a></div>
                        </td>
                    </tr>


                <tr>
                    <td class="col-md-4">
                        <div class="io-description">
                                <b>Parameters :</b>
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                            <tr>
                                                    <td>user</td>
                                            </tr>
                                            <tr>
                                                    <td>followedUser</td>
                                            </tr>
                                    </tbody>
                                </table>
                        </div>
                    </td>
                </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getAllPages"></a>
                    <span class="name">
                        <span ><b>getAllPages</b></span>
                        <a href="#getAllPages"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="149" class="link-to-prism">libs/database/src/lib/services/user.service.ts:149</a></div>
                        </td>
                    </tr>

            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>get all pages</p>
</div>
                </td>
            </tr>

                <tr>
                    <td class="col-md-4">
                        <div class="io-description">
                                <b>Parameters :</b>
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                            <tr>
                                                    <td>queryOptions</td>
                                            </tr>
                                    </tbody>
                                </table>
                        </div>
                    </td>
                </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getFollower"></a>
                    <span class="name">
                        <span ><b>getFollower</b></span>
                        <a href="#getFollower"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="187" class="link-to-prism">libs/database/src/lib/services/user.service.ts:187</a></div>
                        </td>
                    </tr>


                <tr>
                    <td class="col-md-4">
                        <div class="io-description">
                                <b>Parameters :</b>
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                            <tr>
                                                    <td>user</td>
                                            </tr>
                                            <tr>
                                                    <td>queryOption</td>
                                            </tr>
                                    </tbody>
                                </table>
                        </div>
                    </td>
                </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getFollowing"></a>
                    <span class="name">
                        <span ><b>getFollowing</b></span>
                        <a href="#getFollowing"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="225" class="link-to-prism">libs/database/src/lib/services/user.service.ts:225</a></div>
                        </td>
                    </tr>


                <tr>
                    <td class="col-md-4">
                        <div class="io-description">
                                <b>Parameters :</b>
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                            <tr>
                                                    <td>user</td>
                                            </tr>
                                            <tr>
                                                    <td>queryOption</td>
                                            </tr>
                                    </tbody>
                                </table>
                        </div>
                    </td>
                </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserFromCredential"></a>
                    <span class="name">
                        <span ><b>getUserFromCredential</b></span>
                        <a href="#getUserFromCredential"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="60" class="link-to-prism">libs/database/src/lib/services/user.service.ts:60</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserFromId"></a>
                    <span class="name">
                        <span ><b>getUserFromId</b></span>
                        <a href="#getUserFromId"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="69" class="link-to-prism">libs/database/src/lib/services/user.service.ts:69</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="reactive"></a>
                    <span class="name">
                        <span ><b>reactive</b></span>
                        <a href="#reactive"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="322" class="link-to-prism">libs/database/src/lib/services/user.service.ts:322</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="unfollow"></a>
                    <span class="name">
                        <span ><b>unfollow</b></span>
                        <a href="#unfollow"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="178" class="link-to-prism">libs/database/src/lib/services/user.service.ts:178</a></div>
                        </td>
                    </tr>


                <tr>
                    <td class="col-md-4">
                        <div class="io-description">
                                <b>Parameters :</b>
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                            <tr>
                                                    <td>user</td>
                                            </tr>
                                            <tr>
                                                    <td>followedUser</td>
                                            </tr>
                                    </tbody>
                                </table>
                        </div>
                    </td>
                </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="updateUser"></a>
                    <span class="name">
                        <span ><b>updateUser</b></span>
                        <a href="#updateUser"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>() &#x3D;&gt; {...}</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="84" class="link-to-prism">libs/database/src/lib/services/user.service.ts:84</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Model } from &#x27;mongoose&#x27;;
import * as mongoose from &#x27;mongoose&#x27;;
import { Injectable } from &#x27;@nestjs/common&#x27;;
import { InjectModel } from &#x27;@nestjs/mongoose&#x27;;
import { AccountDocument } from &#x27;../schemas/account.schema&#x27;;
import { CredentialDocument, CredentialModel } from &#x27;../schemas&#x27;;
import {
  UserDocument,
  UserType,
  UserModel,
  User
} from &#x27;../schemas/user.schema&#x27;;
import { RelationshipDocument } from &#x27;../schemas/relationship.schema&#x27;;
import { ContentDocument } from &#x27;../schemas/content.schema&#x27;;
import { FollowResponse, PageDto, UpdateUserDto } from &#x27;../dtos/user.dto&#x27;;
import { CastcleQueryOptions } from &#x27;../dtos&#x27;;
import { createPagination } from &#x27;../utils/common&#x27;;
import {
  DEFAULT_QUERY_OPTIONS,
  EntityVisibility,
  Pagination
} from &#x27;../dtos/common.dto&#x27;;
import { ContentService } from &#x27;./content.service&#x27;;

@Injectable()
export class UserService {
  constructor(
    @InjectModel(&#x27;Account&#x27;) public _accountModel: Model&lt;AccountDocument&gt;,
    @InjectModel(&#x27;Credential&#x27;)
    public _credentialModel: CredentialModel,
    @InjectModel(&#x27;User&#x27;)
    public _userModel: UserModel,
    @InjectModel(&#x27;Relationship&#x27;)
    public _relationshipModel: Model&lt;RelationshipDocument&gt;,
    private contentService: ContentService
  ) {}

  getUserFromCredential &#x3D; (credential: CredentialDocument) &#x3D;&gt;
    this._userModel
      .findOne({
        ownerAccount: credential.account._id,
        type: UserType.People,
        visibility: EntityVisibility.Publish
      })
      .exec();

  getUserFromId &#x3D; (id: string) &#x3D;&gt; {
    try {
      if (mongoose.Types.ObjectId(id)) {
        return this._userModel
          .findOne({
            _id: id,
            visibility: EntityVisibility.Publish
          })
          .exec();
      } else return null;
    } catch (error) {
      return null;
    }
  };

  updateUser &#x3D; (user: UserDocument, updateUserDto: UpdateUserDto) &#x3D;&gt; {
    if (!user.profile) user.profile &#x3D; {};
    if (updateUserDto.overview) user.profile.overview &#x3D; updateUserDto.overview;
    if (updateUserDto.dob) user.profile.birthdate &#x3D; updateUserDto.dob;
    if (updateUserDto.links) {
      if (!user.profile.socials) user.profile.socials &#x3D; {};
      const socialNetworks &#x3D; [&#x27;facebook&#x27;, &#x27;medium&#x27;, &#x27;twitter&#x27;, &#x27;youtube&#x27;];
      socialNetworks.forEach((social) &#x3D;&gt; {
        if (updateUserDto.links[social])
          user.profile.socials[social] &#x3D; updateUserDto.links[social];
        if (updateUserDto.links.website)
          user.profile.websites &#x3D; [
            {
              website: updateUserDto.links.website,
              detail: updateUserDto.links.website
            }
          ];
      });
    }
    if (updateUserDto.images) {
      if (!user.profile.images) user.profile.images &#x3D; {};
      if (updateUserDto.images.avatar)
        user.profile.images.avatar &#x3D; updateUserDto.images.avatar;
      if (updateUserDto.images.cover)
        user.profile.images.cover &#x3D; updateUserDto.images.cover;
    }
    console.log(&#x27;saving dto&#x27;, updateUserDto);

    console.log(&#x27;saving website&#x27;, user.profile.websites);
    console.log(&#x27;saving user&#x27;, user);
    return user.save();
  };

  deleteUserFromId &#x3D; (id: string) &#x3D;&gt;
    this._userModel.findByIdAndDelete(id).exec();

  createPageFromCredential &#x3D; async (
    credential: CredentialDocument,
    pageDto: PageDto
  ) &#x3D;&gt; {
    const user &#x3D; await this.getUserFromCredential(credential);
    return this.createPageFromUser(user, pageDto);
  };

  createPageFromUser &#x3D; (user: UserDocument, pageDto: PageDto) &#x3D;&gt; {
    const newPage &#x3D; new this._userModel({
      ownerAccount: user.ownerAccount,
      type: UserType.Page,
      displayId: pageDto.castcleId,
      displayName: pageDto.displayName,
      profile: {
        images: {
          avatar: pageDto.avatar,
          cover: pageDto.cover
        }
      }
    });
    return newPage.save();
  };

  /**
   * get all pages
   * @param {CastcleQueryOptions} queryOptions
   * @returns {Promise&lt;{items:UserDocument[], pagination:Pagination}&gt;}
   */
  getAllPages &#x3D; async (queryOptions: CastcleQueryOptions) &#x3D;&gt; {
    const pagination &#x3D; createPagination(
      queryOptions,
      await this._userModel.count({ type: UserType.Page })
    );
    const itemsQuery &#x3D; this._userModel
      .find({ type: UserType.Page })
      .skip(queryOptions.page - 1)
      .limit(queryOptions.limit);
    let items: UserDocument[];
    if (queryOptions.sortBy.type &#x3D;&#x3D;&#x3D; &#x27;desc&#x27;)
      items &#x3D; await itemsQuery.sort(&#x60;-${queryOptions.sortBy.field}&#x60;).exec();
    else items &#x3D; await itemsQuery.sort(&#x60;${queryOptions.sortBy.field}&#x60;).exec();
    return { items, pagination };
  };
  /**
   *
   * @param {UserDocument} user
   * @param {UserDocument} followedUser
   * @returns {Promise&lt;void&gt;}
   */
  follow &#x3D; async (user: UserDocument, followedUser: UserDocument) &#x3D;&gt;
    user.follow(followedUser);
  /**
   *
   * @param {UserDocument} user
   * @param {UserDocument} followedUser
   * @returns {Promise&lt;void&gt;}
   */
  unfollow &#x3D; async (user: UserDocument, followedUser: UserDocument) &#x3D;&gt;
    user.unfollow(followedUser);

  /**
   *
   * @param user
   * @param queryOption
   * @returns
   */
  getFollower &#x3D; async (
    user: UserDocument,
    queryOption: CastcleQueryOptions &#x3D; DEFAULT_QUERY_OPTIONS
  ) &#x3D;&gt; {
    console.log(&#x27;-----getFollower----&#x27;);

    const filter: { followedUser: any; isFollowPage?: boolean } &#x3D; {
      followedUser: user._id
    };
    console.log(&#x27;filter&#x27;, filter);
    if (queryOption.type)
      filter.isFollowPage &#x3D; queryOption.type &#x3D;&#x3D;&#x3D; UserType.Page ? true : false;
    let query &#x3D; this._relationshipModel
      .find(filter)
      .skip(queryOption.page - 1)
      .limit(queryOption.limit)
      .populate(&#x27;user&#x27;);
    if (queryOption.sortBy.type &#x3D;&#x3D;&#x3D; &#x27;desc&#x27;)
      query &#x3D; query.sort(&#x60;-${queryOption.sortBy.field}&#x60;);
    else query &#x3D; query.sort(&#x60;${queryOption.sortBy.field}&#x60;);
    const totalFollower &#x3D; await this._relationshipModel.count(filter).exec();
    const relationships &#x3D; await query.exec();
    console.log(&#x27;total&#x27;, totalFollower);
    console.log(relationships);
    return {
      items: relationships.map((r) &#x3D;&gt;
        this._userModel.covertToUserResponse(r.user)
      ),
      pagination: createPagination(queryOption, totalFollower)
    };
  };

  /**
   *
   * @param user
   * @param queryOption
   * @returns
   */
  getFollowing &#x3D; async (
    user: UserDocument,
    queryOption: CastcleQueryOptions &#x3D; DEFAULT_QUERY_OPTIONS
  ) &#x3D;&gt; {
    const filter: { user: any; isFollowPage?: boolean } &#x3D; { user: user._id };
    if (queryOption.type)
      filter.isFollowPage &#x3D; queryOption.type &#x3D;&#x3D;&#x3D; UserType.Page ? true : false;
    let query &#x3D; this._relationshipModel
      .find(filter)
      .skip(queryOption.page - 1)
      .limit(queryOption.limit);
    //      .populate(&#x27;followedUser&#x27;);
    if (queryOption.sortBy.type &#x3D;&#x3D;&#x3D; &#x27;desc&#x27;)
      query &#x3D; query.sort(&#x60;-${queryOption.sortBy.field}&#x60;);
    else query &#x3D; query.sort(&#x60;${queryOption.sortBy.field}&#x60;);
    const totalFollowing &#x3D; await this._relationshipModel.count(filter).exec();
    const relationships &#x3D; await query.exec();
    return {
      items: relationships.map((r) &#x3D;&gt;
        this._userModel.covertToUserResponse(r.followedUser)
      ),
      pagination: createPagination(queryOption, totalFollowing)
    };
  };

  /**
   * TODO !!! need to find a way to put in transaction
   * Deactivate User account
   * @param {UserDocument} user
   * @returns {UserDocument}
   */
  deactive &#x3D; async (user: UserDocument) &#x3D;&gt; {
    //all page from user has to be delete
    if (user.type &#x3D;&#x3D;&#x3D; UserType.People) {
      //check if he has a page;
      //each page has to be deactivated
      const pages &#x3D; await this._userModel
        .find({ ownerAccount: user.ownerAccount, type: UserType.Page })
        .exec();
      const promiseDeactivatePages &#x3D; pages.map((p) &#x3D;&gt; this.deactive(p));
      await Promise.all(promiseDeactivatePages);
      //all content from page of user has to be delete
    }
    //TODO !!! will move this logic to queue
    /*
    //all content form user has to be delete
    //TODO !!! this should move to cron or something to do at background and add pagination
    const contents &#x3D; await this.contentService._contentModel
      .find({ &#x27;author.id&#x27;: user._id })
      .exec();
    const promiseRemoveContents: Promise&lt;ContentDocument&gt;[] &#x3D; contents.map(
      (contentItem) &#x3D;&gt; this.contentService.deleteContentFromId(contentItem._id)
    );
    await Promise.all(promiseRemoveContents);

    //remove all engagements (like) Aggregator that this user do (quote/requote agg) already remove with deleteContentFromId()
    //TODO !!! need to improve performance by bypass the engagement save hook and use updateMany instead
    // but need to find a way to get all engagement contents to be more effective
    const engagements &#x3D; await this.contentService._engagementModel
      .find({ user: user._id, visibility: EntityVisibility.Publish })
      .exec();
    const promiseHideEngagements &#x3D; engagements.map((engagement) &#x3D;&gt; {
      engagement.visibility &#x3D; EntityVisibility.Hidden;
      return engagement.save();
    });
    await Promise.all(promiseHideEngagements);
    //update follower / followee aggregator
    const relationships &#x3D; await this._relationshipModel
      .find({ user: user._id })
      .populate(&#x27;followedUser&#x27;)
      .exec();
    //TODO !!! need to improve performance
    const promiseUpdateFollower &#x3D; relationships.map((r) &#x3D;&gt;
      this._userModel
        .updateOne(r._id, {
          $inc: {
            followerCount: -1
          }
        })
        .exec()
    );
    await Promise.all(promiseUpdateFollower);
    */
    //change status to delete
    user.visibility &#x3D; EntityVisibility.Deleted;
    const userResult &#x3D; user.save();
    //deactive userAccount
    if (user.type &#x3D;&#x3D;&#x3D; UserType.Page)
      await this._accountModel.updateOne(
        { _id: user.ownerAccount },
        {
          visibility: EntityVisibility.Deleted
        }
      );
    return userResult;
  };

  reactive &#x3D; async (user: UserDocument) &#x3D;&gt; {
    //all page from user has to be delete
    if (user.type &#x3D;&#x3D;&#x3D; UserType.People) {
      //check if he has a page;
      //each page has to be deactivated
      const pages &#x3D; await this._userModel
        .find({ ownerAccount: user.ownerAccount, type: UserType.Page })
        .exec();
      const promiseReactivatePages &#x3D; pages.map((p) &#x3D;&gt; this.reactive(p));
      await Promise.all(promiseReactivatePages);
      //all content from page of user has to be delete
    }
    //TODO !!! will move this logic to queue
    /*
    //all content form user has to be delete
    //TODO !!! this should move to cron or something to do at background and add pagination
    const contents &#x3D; await this.contentService._contentModel
      .find({ &#x27;author.id&#x27;: user._id })
      .exec();
    const promiseReactiveContents: Promise&lt;ContentDocument&gt;[] &#x3D; contents.map(
      (contentItem) &#x3D;&gt; this.contentService.recoverContentFromId(contentItem._id)
    );
    await Promise.all(promiseReactiveContents);

    //remove all engagements (like) Aggregator that this user do (quote/requote agg) already remove with deleteContentFromId()
    //TODO !!! need to improve performance by bypass the engagement save hook and use updateMany instead
    // but need to find a way to get all engagement contents to be more effective
    const engagements &#x3D; await this.contentService._engagementModel
      .find({ user: user._id, visibility: EntityVisibility.Publish })
      .exec();
    const promisePublishEngagements &#x3D; engagements.map((engagement) &#x3D;&gt; {
      engagement.visibility &#x3D; EntityVisibility.Publish;
      return engagement.save();
    });
    await Promise.all(promisePublishEngagements);
    //update follower / followee aggregator
    const relationships &#x3D; await this._relationshipModel
      .find({ user: user._id })
      .populate(&#x27;followedUser&#x27;)
      .exec();
    //TODO !!! need to improve performance
    const promiseUpdateFollower &#x3D; relationships.map((r) &#x3D;&gt;
      this._userModel
        .updateOne(r._id, {
          $inc: {
            followerCount: 1
          }
        })
        .exec()
    );
    await Promise.all(promiseUpdateFollower);
    */
    //change status to delete
    user.visibility &#x3D; EntityVisibility.Publish;
    //deactive userAccount
    if (user.type &#x3D;&#x3D;&#x3D; UserType.Page)
      await this._accountModel.updateOne(
        { _id: user.ownerAccount },
        {
          visibility: EntityVisibility.Publish
        }
      );
    return user.save();
  };
}
</code></pre>
    </div>

</div>







                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'UserService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       
       <script type="module" src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
